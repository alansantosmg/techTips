Canvas LMS install

Instalar o banco de dados postgres (versão 9 ou superior) no servidor de banco de dados `dbocnsrv`:

```
sudo apt-get install postgresql`
```

Editar o arquivo /etc/postresql/10/main/pg_config.hba
incluir a linha

```
host all all 192.168.56.200/32 trust
```

Iniciar banco de dados

```
service postgresql start

```

Editar o arquivo /etc/postgresl/10/main/postgresql.conf
Incluir a linha

```
listen_addresses = '*'
```

Criar usuário `canvas` p/ uso da conexão do banco de dados do sistema Canvas:

```
sudo -u postgres createuser canvas --no-createdb --no-superuser --no-createrole --pwprompt`
```

Criar banco de dados `canvas_production`:

```
sudo -u postgres createdb canvas_production --owner=canvas`
```

Fazer download do tarball do canvas ou clonar do github
git clone https://

Descompactar o canvas

```
tar -xzvf canvas-lms-stable.tar.gz
```

Criar o diretório /var/canvas

```
mkdir -p /var/canvas
```

Copiar arquivo do do diretório para /va/canvas

```
chown -R mysuseradm /var/canvas

cd canvas-lms-stable

cp -av . /var/canvas

```

Instalar dependencias do Ruby
Observação: na documentação oficial informa para instalar o Ruby 2.4, porém esta versão já foi descontinuada.

```
sudo apt-get install ruby ruby-dev zlib1g-dev libxml2-dev   libsqlite3-dev postgresql libpq-dev libxmlsec1-dev curl make g++
```

instalar o Node.js

```
curl -sL https://deb.nodesource.com/setup_10.x | sudo -E bash -

sudo apt-get install nodejs
```

Reiniciar o computador ou iniciar o serviço do Postgresql

```
service postgresql start

```

Criar usuário no Postgresql

```
sudo -u postgres createuser $USER

sudo -u postgres psql -c "alter user $USER with superuser" postgres
```

Install bunbler -- Ruby package manager

```
cd /var/canvas

sudo gem install bundler --version 1.13.6

bundle _1.13.6_ install --path vendor/bundle
```

Install yarn

```
cd /var/canvas

curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | sudo apt-key add -

echo "deb https://dl.yarnpkg.com/debian/ stable main" | sudo tee /etc/apt/sources.list.d/yarn.list

sudo apt-get update && sudo apt-get install yarn=1.10.1-1

sudo apt-get install python

yarn install
```

Copy basic configuration files

```
cd /var/canvas

for config in amazon_s3 database delayed_jobs domain file_store outgoing_mail security external_migration; do cp config/$config.yml.example config/$config.yml; done

```

Copy dynamic settings Configuration

```
cd /var/canvas

cp config/dynamic_settings.yml.example config/dynamic_settings.yml

nano config/dynamic_settings.yml
```

Copy database configuration
Insert the database host, user and password in ./config/database.yml

```
cd /var/canvas

cp config/database.yml.example config/database.yml

nano config/database.yml
```

Copy smtp configuration
Insert smtp configuration: smtp server address, port, auth-type, user, password.

```
cd /var/canvas

cp config/outgoing_mail.yml.example config/outgoing_mail.yml

nano config/outgoing_mail.yml
```

Copy domain configuration. Insert your domain name

```
cd /var/canvas

cp config/domain.yml.example config/domain.yml

nano config/domain.yml
```

Insert 20 random characters in security file (subs 12345)

```
cp config/security.yml.example config/security.yml

nano config/security.yml
```

Generate Assets

```
cd /var/canvas

mkdir -p log tmp/pids public/assets app/stylesheets/brandable_css_brands

touch app/stylesheets/_brandable_variables_defaults_autogenerated.scss

touch Gemfile.lock

touch log/production.log

sudo chown -R alan config/environment.rb log tmp public/assets app/stylesheets/\_brandable_variables_defaults_autogenerated.scss app/stylesheets/brandable_css_brands Gemfile.lock config.ru
```

Compile parameters to modules

```
cd /var/canvas

yarn install

RAILS_ENV=production bundle exec rake canvas:compile_assets

sudo chown -R alan public/dist/brandable_css
```

Populate database.
Your are promped to create admin account.

```
RAILS_ENV=production bundle exec rake db:initial_setup
```

Set up or choose a user you want the Canvas Rails application to run as. This can be the same user as your webserver (www-data on Debian/Ubuntu), your personal user account, or something else. Once you've chosen or created a new user, you need to change the ownership of key files in your application root to that user.

```
sudo adduser --disabled-password --gecos canvas alan
```

Secure config files

```
sudo chown canvasuser config/*.yml
sudo chmod 400 config/*.yml
```

Obter passenger

```
sudo apt-get install -y dirmngr gnupg

sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys 561F9B9CAC40B2F7

sudo apt-get install -y apt-transport-https ca-certificates


sudo sh -c 'echo deb https://oss-binaries.phusionpassenger.com/apt/passenger bionic main > /etc/apt/sources.list.d/passenger.list'

sudo apt-get update

sudo apt-get install -y libapache2-mod-passenger
```

obter apache

```
sudo apt-get install passenger libapache2-mod-passenger apache2
```

Instalar módulos do apache

```
sudo a2enmod passenger

sudo a2enmod rewrite

systemctl restart apache2
```

Habilitar ssl para Apache2

```
sudo a2enmod ssl
```

Unlink other sites

```
sudo unlink /etc/apache2/sites-enabled/000-default.conf
```

Create apache virtual host.

```
Change servername, serveralias, serveradmin.
sudo nano /etc/apache2/sites-available/canvas.conf
```

```
<VirtualHost *:80>
  ServerName canvas.example.com
  ServerAlias canvasfiles.example.com
  ServerAdmin youremail@example.com
  DocumentRoot /var/canvas/public
  RewriteEngine On
  RewriteCond %{HTTP:X-Forwarded-Proto} !=https
  RewriteCond %{REQUEST_URI} !^/health_check
  RewriteRule (.*) https://%{HTTP_HOST}%{REQUEST_URI} [L]
  ErrorLog /var/log/apache2/canvas_errors.log
  LogLevel warn
  CustomLog /var/log/apache2/canvas_access.log combined
  SetEnv RAILS_ENV production
  <Directory /var/canvas/public>
    Allow from all
    Options -MultiViews
  </Directory>
</VirtualHost>
<VirtualHost *:443>
  ServerName canvas.example.com
  ServerAlias canvasfiles.example.com
  ServerAdmin youremail@example.com
  DocumentRoot /var/canvas/public
  ErrorLog /var/log/apache2/canvas_errors.log
  LogLevel warn
  CustomLog /var/log/apache2/canvas_ssl_access.log combined
  SSLEngine on
  BrowserMatch "MSIE [17-9]" ssl-unclean-shutdown
  # the following ssl certificate files are generated for you from the ssl-cert package.
  SSLCertificateFile /etc/ssl/certs/ssl-cert-snakeoil.pem
  SSLCertificateKeyFile /etc/ssl/private/ssl-cert-snakeoil.key
  SetEnv RAILS_ENV production
  <Directory /var/canvas/public>
    Allow from all
    Options -MultiViews
  </Directory>
</VirtualHost>
```

Make site avaliable

```
sudo a2ensite canvas
```

Optimize file Downloads

```
sudo apt-get install libapache2-mod-xsendfile
```

Verifiy if xsendfile is loaded

```
sudo apachectl -M | sort
```

install redis cache

```
sudo add-apt-repository ppa:chris-lea/redis-server

sudo apt-get update

sudo apt-get install redis-server

sudo systemctl restart redis-server
```
